Prompt 3: Fix Menu Bar Icon + Wire Up GitHub API
MISSION
Work in the existing repo at /Users/calebbelshe/Code/openProjects/projectStats. Two objectives:

Fix the menu bar icon not appearing
Wire up GitHub API integration for enhanced stats (stars, forks, issues, PRs, contribution calendar)

META OUTPUT INSTRUCTIONS (NON-NEGOTIABLE)
You must follow this 4-part response structure:

Plan: outline moves in order, what you will NOT touch
Difficulty: brief estimate and likely failure points
Execute: do the work with strict discipline; minimal edits
Report + self-grade: what changed, why, grade yourself (A–F)

WORK LOG ARTIFACT (REQUIRED)
Create: /work/YYYY-MM-DD_HHMM_menubar-and-github-api.md
Contents: prompt summary + closing report
STATS TRACKING (REQUIRED)
After each commit, create a stats file:

Location: /work/stats/YYYY-MM-DD_HHMM_[commit-hash].md
Contents:

started: YYYY-MM-DDTHH:MM:SS
ended: YYYY-MM-DDTHH:MM:SS
lines_added: [number]
lines_deleted: [number]
commit: [7-char hash]

Brief description of work completed (under 50 words).
Get line counts from git diff --stat HEAD~1 after committing. Get commit hash from git rev-parse --short HEAD.
COMMIT AND PUSH (REQUIRED)
Use two commits:

"Fix menu bar icon not appearing"
"Add GitHub API integration for enhanced repo stats"

Push to main after each. Create stats file for each commit.
PROCESS RULES (NON-NEGOTIABLE)

Follow existing patterns in the codebase
All existing functionality must continue to work
No breaking changes to current local git stats
GitHub API is additive/optional enhancement


SCOPE A: Fix Menu Bar Icon
Problem: Menu bar icon not visible after app launch.
Investigation & Fixes:

Check the SF Symbol name - "chevron.left.forwardslash.chevron.right" may not exist. Replace with known working icon:

swiftMenuBarExtra("ProjectStats", systemImage: "chart.bar.xaxis")

Ensure MenuBarExtra is not conditionally rendered
Verify in ProjectStatsApp.swift the MenuBarExtra scene is at the same level as WindowGroup (not nested)
Check that INFOPLIST_KEY_LSUIElement = YES is set in build settings (should already be there)

File: projectStats/projectStats/App/ProjectStatsApp.swift

SCOPE B: GitHub API Integration
File to modify: projectStats/projectStats/Services/GitHubClient.swift
The file exists but needs to be fully implemented and wired up.
B1: GitHubClient Implementation
swiftimport Foundation

struct GitHubRepo: Codable {
    let name: String
    let fullName: String
    let description: String?
    let stargazersCount: Int
    let forksCount: Int
    let openIssuesCount: Int
    let language: String?
    let updatedAt: String
    
    enum CodingKeys: String, CodingKey {
        case name
        case fullName = "full_name"
        case description
        case stargazersCount = "stargazers_count"
        case forksCount = "forks_count"
        case openIssuesCount = "open_issues_count"
        case language
        case updatedAt = "updated_at"
    }
}

struct GitHubCommit: Codable {
    let sha: String
    let commit: CommitDetail
    let stats: CommitStats?
    
    struct CommitDetail: Codable {
        let message: String
        let author: CommitAuthor
    }
    
    struct CommitAuthor: Codable {
        let name: String
        let date: String
    }
    
    struct CommitStats: Codable {
        let additions: Int
        let deletions: Int
        let total: Int
    }
}

struct ContributionDay: Codable {
    let date: String
    let contributionCount: Int
}

struct ContributionWeek: Codable {
    let contributionDays: [ContributionDay]
}

struct ContributionCalendar: Codable {
    let totalContributions: Int
    let weeks: [ContributionWeek]
}

class GitHubClient: ObservableObject {
    static let shared = GitHubClient()
    
    @Published var isAuthenticated = false
    
    private var token: String? {
        SettingsViewModel.shared.githubToken.isEmpty ? nil : SettingsViewModel.shared.githubToken
    }
    
    private let baseURL = "https://api.github.com"
    private let session = URLSession.shared
    
    private init() {
        isAuthenticated = token != nil
    }
    
    func refreshAuthStatus() {
        isAuthenticated = token != nil && !token!.isEmpty
    }
    
    // MARK: - REST API Methods
    
    func getRepo(owner: String, repo: String) async throws -> GitHubRepo {
        let url = URL(string: "\(baseURL)/repos/\(owner)/\(repo)")!
        let data = try await makeRequest(url: url)
        return try JSONDecoder().decode(GitHubRepo.self, from: data)
    }
    
    func getCommits(owner: String, repo: String, since: Date? = nil, perPage: Int = 30) async throws -> [GitHubCommit] {
        var urlString = "\(baseURL)/repos/\(owner)/\(repo)/commits?per_page=\(perPage)"
        
        if let since = since {
            let formatter = ISO8601DateFormatter()
            urlString += "&since=\(formatter.string(from: since))"
        }
        
        let url = URL(string: urlString)!
        let data = try await makeRequest(url: url)
        return try JSONDecoder().decode([GitHubCommit].self, from: data)
    }
    
    func getCommitStats(owner: String, repo: String, sha: String) async throws -> GitHubCommit {
        let url = URL(string: "\(baseURL)/repos/\(owner)/\(repo)/commits/\(sha)")!
        let data = try await makeRequest(url: url)
        return try JSONDecoder().decode(GitHubCommit.self, from: data)
    }
    
    // MARK: - GraphQL for Contribution Calendar
    
    func getContributionCalendar(username: String) async throws -> ContributionCalendar {
        let query = """
        query {
            user(login: "\(username)") {
                contributionsCollection {
                    contributionCalendar {
                        totalContributions
                        weeks {
                            contributionDays {
                                date
                                contributionCount
                            }
                        }
                    }
                }
            }
        }
        """
        
        let url = URL(string: "https://api.github.com/graphql")!
        var request = URLRequest(url: url)
        request.httpMethod = "POST"
        request.setValue("application/json", forHTTPHeaderField: "Content-Type")
        
        if let token = token {
            request.setValue("Bearer \(token)", forHTTPHeaderField: "Authorization")
        }
        
        let body = ["query": query]
        request.httpBody = try JSONSerialization.data(withJSONObject: body)
        
        let (data, response) = try await session.data(for: request)
        
        guard let httpResponse = response as? HTTPURLResponse, httpResponse.statusCode == 200 else {
            throw GitHubError.requestFailed
        }
        
        // Parse GraphQL response
        let json = try JSONSerialization.jsonObject(with: data) as? [String: Any]
        let dataObj = json?["data"] as? [String: Any]
        let user = dataObj?["user"] as? [String: Any]
        let collection = user?["contributionsCollection"] as? [String: Any]
        let calendarData = collection?["contributionCalendar"] as? [String: Any]
        
        guard let calendarData = calendarData else {
            throw GitHubError.parseError
        }
        
        let calendarJSON = try JSONSerialization.data(withJSONObject: calendarData)
        return try JSONDecoder().decode(ContributionCalendar.self, from: calendarJSON)
    }
    
    // MARK: - Helper to parse owner/repo from GitHub URL
    
    static func parseGitHubURL(_ urlString: String) -> (owner: String, repo: String)? {
        // Handle: https://github.com/owner/repo or git@github.com:owner/repo.git
        let cleaned = urlString
            .replacingOccurrences(of: "https://github.com/", with: "")
            .replacingOccurrences(of: "git@github.com:", with: "")
            .replacingOccurrences(of: ".git", with: "")
        
        let parts = cleaned.split(separator: "/")
        guard parts.count >= 2 else { return nil }
        
        return (String(parts[0]), String(parts[1]))
    }
    
    // MARK: - Private
    
    private func makeRequest(url: URL) async throws -> Data {
        var request = URLRequest(url: url)
        request.setValue("application/vnd.github.v3+json", forHTTPHeaderField: "Accept")
        
        if let token = token {
            request.setValue("Bearer \(token)", forHTTPHeaderField: "Authorization")
        }
        
        let (data, response) = try await session.data(for: request)
        
        guard let httpResponse = response as? HTTPURLResponse else {
            throw GitHubError.requestFailed
        }
        
        switch httpResponse.statusCode {
        case 200...299:
            return data
        case 401:
            throw GitHubError.unauthorized
        case 403:
            throw GitHubError.rateLimited
        case 404:
            throw GitHubError.notFound
        default:
            throw GitHubError.requestFailed
        }
    }
}

enum GitHubError: Error, LocalizedError {
    case unauthorized
    case rateLimited
    case notFound
    case requestFailed
    case parseError
    
    var errorDescription: String? {
        switch self {
        case .unauthorized: return "Invalid GitHub token"
        case .rateLimited: return "GitHub API rate limit exceeded"
        case .notFound: return "Repository not found"
        case .requestFailed: return "GitHub API request failed"
        case .parseError: return "Failed to parse GitHub response"
        }
    }
}
B2: Add GitHub Stats to Project Model
File: projectStats/projectStats/Models/Project.swift
Add optional GitHub stats to the Project struct:
swiftstruct GitHubStats {
    var stars: Int = 0
    var forks: Int = 0
    var openIssues: Int = 0
    var watchers: Int = 0
}
Add to Project:
swiftvar githubStats: GitHubStats?
B3: Wire Up in DashboardViewModel
File: projectStats/projectStats/ViewModels/DashboardViewModel.swift
Add method to fetch GitHub stats for projects:
swiftprivate let githubClient = GitHubClient.shared

func fetchGitHubStats() async {
    guard githubClient.isAuthenticated else { return }
    
    for i in projects.indices {
        guard let urlString = projects[i].githubURL,
              let (owner, repo) = GitHubClient.parseGitHubURL(urlString) else {
            continue
        }
        
        do {
            let repoInfo = try await githubClient.getRepo(owner: owner, repo: repo)
            await MainActor.run {
                projects[i].githubStats = GitHubStats(
                    stars: repoInfo.stargazersCount,
                    forks: repoInfo.forksCount,
                    openIssues: repoInfo.openIssuesCount
                )
            }
        } catch {
            print("Failed to fetch GitHub stats for \(repo): \(error)")
        }
    }
}
Call it after loading projects in loadData():
swiftfunc loadData() async {
    // ... existing code ...
    
    // Fetch GitHub stats if authenticated
    await fetchGitHubStats()
}
B4: Display GitHub Stats in UI
File: projectStats/projectStats/Views/Projects/ProjectRowView.swift or ProjectDetailView.swift
Add display for stars/forks when available:
swiftif let stats = project.githubStats {
    HStack(spacing: 12) {
        Label("\(stats.stars)", systemImage: "star.fill")
            .foregroundStyle(.yellow)
        Label("\(stats.forks)", systemImage: "tuningfork")
            .foregroundStyle(.secondary)
        if stats.openIssues > 0 {
            Label("\(stats.openIssues)", systemImage: "exclamationmark.circle")
                .foregroundStyle(.orange)
        }
    }
    .font(.caption)
}
B5: Settings UI for GitHub Token
File: projectStats/projectStats/Views/Settings/SettingsView.swift
Ensure there's a section for entering the GitHub PAT. Should already exist - verify it saves to SettingsViewModel.shared.githubToken and add a "Test Connection" button:
swiftSection("GitHub Integration") {
    SecureField("Personal Access Token", text: $settingsViewModel.githubToken)
        .textFieldStyle(.roundedBorder)
    
    Text("Generate a token at GitHub → Settings → Developer Settings → Personal Access Tokens")
        .font(.caption)
        .foregroundStyle(.secondary)
    
    if !settingsViewModel.githubToken.isEmpty {
        HStack {
            Image(systemName: "checkmark.circle.fill")
                .foregroundStyle(.green)
            Text("Token configured")
        }
        .font(.caption)
    }
}

VERIFICATION CHECKLIST

 Build succeeds
 Menu bar icon appears (top right of screen)
 Clicking menu bar icon shows popover with projects
 Dashboard still shows local git stats
 Settings has GitHub token field
 When token entered, GitHub stats (stars/forks) appear on projects
 App handles missing/invalid token gracefully (no crash)

FINAL RESPONSE REQUIREMENTS

Follow 4-part structure
List files created/modified
Confirm build passes
Include commit hashes (both)
Confirm stats files created (both)

DO NOT:

Break existing local git functionality
Require GitHub token for app to work (it's optional enhancement)
Store token insecurely
Make excessive API calls (cache results)
Skip creating stats files