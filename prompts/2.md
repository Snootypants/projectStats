# Prompt 2: Fix NSApp Crash on Launch

## MISSION
Work in the existing repo at `/Users/calebbelshe/Code/openProjects/projectStats`. Fix the fatal crash that occurs immediately on app launch due to `NSApp` being nil during `SettingsViewModel` initialization.

## META OUTPUT INSTRUCTIONS (NON-NEGOTIABLE)
You must follow this 4-part response structure:
1. **Plan:** outline moves in order, what you will NOT touch
2. **Difficulty:** brief estimate and likely failure points
3. **Execute:** do the work with strict discipline; minimal edits
4. **Report + self-grade:** what changed, why, grade yourself (Aâ€“F)

## WORK LOG ARTIFACT (REQUIRED)
Create: `/work/YYYY-MM-DD_HHMM_fix-nsapp-crash.md`
Contents: prompt summary + closing report

## STATS TRACKING (REQUIRED)
After each commit, create a stats file:
- Location: `/work/stats/YYYY-MM-DD_HHMM_[commit-hash].md`
- Filename example: `/work/stats/2026-01-30_0900_a3f7b2c.md`
- Contents:
```
started: YYYY-MM-DDTHH:MM:SS
ended: YYYY-MM-DDTHH:MM:SS
lines_added: [number]
lines_deleted: [number]
commit: [7-char hash]

Brief description of work completed (under 50 words).
```
Get line counts from `git diff --stat HEAD~1` after committing. Get commit hash from `git rev-parse --short HEAD`.

## COMMIT AND PUSH (REQUIRED)
After all changes are complete and verified:
- Commit message format: `"Fix NSApp crash on launch by deferring theme application"`
- Push to main
- Create stats file for the commit

## PROCESS RULES (NON-NEGOTIABLE)
- Follow existing patterns in the codebase
- Minimal changes - fix only what's broken
- No changes to other ViewModels or Views
- No new dependencies

---

## SCOPE A: Fix SettingsViewModel Init Crash

**Error:**
```
Thread 1: Fatal error: Unexpectedly found nil while implicitly unwrapping an Optional value
```

**Location:** `SettingsViewModel.swift` line 88, `applyTheme()` called from `init()`

**Cause:** `NSApp` doesn't exist yet when `SettingsViewModel.shared` is initialized during app startup

**Fix:** In `projectStats/projectStats/ViewModels/SettingsViewModel.swift`, change:

```swift
private init() {
    applyTheme()
}
```

To:

```swift
private init() {
    // Defer theme application until NSApp exists
    DispatchQueue.main.async { [weak self] in
        self?.applyTheme()
    }
}
```

---

## VERIFICATION CHECKLIST
- [ ] `swift build` succeeds (or Xcode build succeeds)
- [ ] App launches without crashing
- [ ] Menu bar icon appears
- [ ] Clicking menu bar icon shows popover
- [ ] Theme changes still work in Settings

## FINAL RESPONSE REQUIREMENTS
- Follow 4-part structure
- List files created/modified
- Confirm build passes
- Include commit hash
- Confirm stats file created

## DO NOT:
- Modify any other files
- Change the theme logic itself
- Remove the `applyTheme()` call entirely
- Break existing functionality
- Skip creating the stats file